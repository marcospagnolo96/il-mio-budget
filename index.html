<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet 2026 Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --info: #3498db; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: white; padding: 20px; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        .nav-btn { padding: 12px; margin-bottom: 5px; border: none; background: #eee; text-align: left; cursor: pointer; font-weight: bold; border-radius: 8px; }
        .nav-btn.active { background: var(--primary); color: white; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .form-box { background: #fdfdfd; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-top: 15px; }
        .type-selector { display: flex; gap: 8px; margin-bottom: 12px; }
        .type-btn { flex: 1; padding: 10px; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: bold; border-radius: 8px; font-size: 0.8rem; }
        .type-btn.inc-active { border-color: var(--success); color: var(--success); background: #eafaf1; }
        .type-btn.exp-active { border-color: var(--danger); color: var(--danger); background: #fdf2f2; }
        input, select, .btn-save { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; margin-bottom: 8px; }
        .btn-save { background: var(--primary); color: white; font-weight: bold; cursor: pointer; border: none; }
        .table-container { background: white; padding: 10px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        .table-annual { width: 100%; border-collapse: collapse; font-size: 0.72rem; table-layout: fixed; }
        .table-annual th, .table-annual td { border: 1px solid #eee; padding: 6px 2px; text-align: center; overflow: hidden; white-space: nowrap; }
        .row-label { text-align: left !important; font-weight: bold; width: 110px; position: sticky; left: 0; background: #fdfdfd; }
        .col-tot { font-weight: bold; background: #f1f3f5; width: 50px; }
        .col-avg { font-weight: bold; background: #ebf2f7; color: #2980b9; width: 50px; }
        .chart-box { height: 250px; background: white; border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid #eee; }
        .val-inc { color: var(--success); }
        .val-exp { color: var(--danger); }
        #sync-status { font-size: 0.75rem; margin-top: 10px; color: #7f8c8d; text-align: center; }
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

<div id="auth-screen" class="auth-overlay">
    <h1>üí∞ Wallet Cloud 2026</h1>
    <p>Sincronizza i tuoi dati con Google Drive per usarli su tutti i dispositivi.</p>
    <button id="auth-btn" style="padding: 15px 30px; font-size: 1rem; cursor: pointer; background: var(--info); color: white; border: none; border-radius: 5px; font-weight: bold;" onclick="handleAuthClick()">ACCEDI CON GOOGLE</button>
    <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 20px;">Nota: Se il tasto non risponde, attendi 2 secondi o ricarica la pagina.</p>
</div>

<aside class="sidebar">
    <h2>üí∞ Wallet 2026</h2>
    <button class="nav-btn active" onclick="showPage('dashboard', this)">üìä Riepilogo Annuale</button>
    <button class="nav-btn" onclick="showPage('monthly', this)">üìÖ Vista Mensile</button>
    <button class="nav-btn" onclick="showPage('history', this)">üìù Lista & Categorie</button>
    
    <div id="sync-status">In attesa di connessione...</div>

    <div class="form-box">
        <div class="type-selector">
            <button id="btn-inc" class="type-btn inc-active" onclick="setType('Entrata')">Entrata</button>
            <button id="btn-exp" class="type-btn" onclick="setType('Uscita')">Uscita</button>
        </div>
        <input type="date" id="date">
        <input type="text" id="desc" placeholder="Descrizione...">
        <select id="cat-select"></select>
        <input type="number" id="amount" step="0.01" placeholder="Importo ‚Ç¨">
        <button class="btn-save" onclick="addRecord()">Salva Movimento</button>
    </div>
    <button onclick="handleSignoutClick()" style="margin-top:auto; font-size: 0.7rem; background:none; border:none; color:gray; cursor:pointer; padding: 10px;">Esci dall'account</button>
</aside>

<main class="main-content">
    <div id="dashboard" class="page active">
        <div class="chart-box" style="height: 220px;"><canvas id="mainChart"></canvas></div>
        <h3>üìä Bilancio Annuale</h3>
        <div class="table-container"><table class="table-annual"><thead><tr id="h-sum"></tr></thead><tbody id="b-sum"></tbody></table></div>
        <h3>üìà Entrate Annuali</h3>
        <div class="table-container"><table class="table-annual"><thead><tr id="h-inc"></tr></thead><tbody id="b-inc"></tbody></table></div>
        <h3>üìâ Uscite Annuali</h3>
        <div class="table-container"><table class="table-annual"><thead><tr id="h-exp"></tr></thead><tbody id="b-exp"></tbody></table></div>
        <h3>üìä Spesa Media Mensile per Categoria</h3>
        <div class="chart-box" style="height: 300px;"><canvas id="avgExpChart"></canvas></div>
    </div>

    <div id="monthly" class="page">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Dettaglio Mese: <select id="month-filter" onchange="render()" style="width: 150px; padding: 5px;"></select></h3>
            <div id="m-summary-stats" style="font-weight: bold; font-size: 1.1rem;"></div>
        </div>
        <div style="display: flex; gap: 20px;">
            <div style="flex:1;">
                <h4 class="val-inc">Entrate: Previsto vs Reale</h4>
                <div class="chart-box"><canvas id="mChartInc"></canvas></div>
                <div class="table-container"><table style="width:100%; border-collapse:collapse; font-size:0.8rem;"><thead><tr style="background:#f1f3f5;"><th>Cat</th><th>Prev</th><th>Reale</th><th>Diff</th></tr></thead><tbody id="m-inc-body"></tbody></table></div>
            </div>
            <div style="flex:1;">
                <h4 class="val-exp">Uscite: Previsto vs Reale</h4>
                <div class="chart-box"><canvas id="mChartExp"></canvas></div>
                <div class="table-container"><table style="width:100%; border-collapse:collapse; font-size:0.8rem;"><thead><tr style="background:#f1f3f5;"><th>Cat</th><th>Prev</th><th>Reale</th><th>Diff</th></tr></thead><tbody id="m-exp-body"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="history" class="page">
        <h3>‚öôÔ∏è Budget & Storico</h3>
        <div style="display: flex; gap: 20px; margin-bottom: 30px;">
            <div style="flex:1; background:white; padding:15px; border-radius:10px; border:1px solid #ddd;">
                <h4 class="val-inc">Budget Entrate</h4>
                <div id="edit-cats-inc"></div>
            </div>
            <div style="flex:1; background:white; padding:15px; border-radius:10px; border:1px solid #ddd;">
                <h4 class="val-exp">Budget Uscite</h4>
                <div id="edit-cats-exp"></div>
            </div>
        </div>
        <div class="table-container">
            <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
                <thead style="background:#f1f3f5;"><tr><th>Data</th><th>Descrizione</th><th>Categoria</th><th>Tipo</th><th>Importo</th><th>Az.</th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    /* CONFIGURAZIONE GOOGLE DRIVE */
    const CLIENT_ID = '748854814089-olhm7pebtjdn7beu9j5jt7n8hfj8pih2.apps.googleusercontent.com';
    const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let fileId = null;

    const months = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
    let records = [];
    let catsInc = [{n: "Stipendio", b: 2000}];
    let catsExp = [{n: "Cibo", b: 400}, {n: "Casa", b: 600}];
    let currentType = 'Entrata';
    let chart, mChartInc, mChartExp, avgExpChart;

    /* INIZIALIZZAZIONE GOOGLE */
    function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; }); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; }

    async function handleAuthClick() {
        if (!tokenClient) return alert("Google non pronto. Ricarica la pagina.");
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) throw (resp);
            document.getElementById('auth-screen').style.display = 'none';
            await syncData();
        };
        tokenClient.requestAccessToken({prompt: 'consent'});
    }

    async function syncData() {
        document.getElementById('sync-status').innerText = "üîÑ Sincronizzazione...";
        const response = await gapi.client.drive.files.list({ q: "name = 'wallet_2026_data.json' and trashed = false" });
        const files = response.result.files;
        if (files.length > 0) {
            fileId = files[0].id;
            const fileData = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            const data = fileData.result;
            records = data.records || [];
            catsInc = data.catsInc || catsInc;
            catsExp = data.catsExp || catsExp;
        } else {
            await createNewFile();
        }
        document.getElementById('sync-status').innerText = "‚úÖ Cloud Sincronizzato";
        render();
    }

    async function createNewFile() {
        const content = JSON.stringify({records, catsInc, catsExp});
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=media', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token, 'Content-Type': 'application/json' },
            body: content
        });
        const resJson = await response.json();
        fileId = resJson.id;
        await gapi.client.drive.files.update({ fileId: fileId, resource: { name: 'wallet_2026_data.json' } });
    }

    async function saveToCloud() {
        if (!fileId) return;
        document.getElementById('sync-status').innerText = "üîÑ Salvataggio...";
        const content = JSON.stringify({records, catsInc, catsExp});
        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token, 'Content-Type': 'application/json' },
            body: content
        });
        document.getElementById('sync-status').innerText = "‚úÖ Salvato";
    }

    /* LOGICA APP */
    window.onload = () => {
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        const mFilter = document.getElementById('month-filter');
        months.forEach((m, i) => {
            const opt = `<option value="${i}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`;
            mFilter.innerHTML += opt;
        });
        updateCatDropdown();
    };

    function setType(t) { currentType = t; document.getElementById('btn-inc').classList.toggle('inc-active', t === 'Entrata'); document.getElementById('btn-exp').classList.toggle('exp-active', t === 'Uscita'); updateCatDropdown(); }
    function showPage(id, btn) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.add('active'); btn.classList.add('active'); render(); }
    function updateCatDropdown() { const list = currentType === 'Entrata' ? catsInc : catsExp; document.getElementById('cat-select').innerHTML = list.map(c => `<option value="${c.n}">${c.n}</option>`).join(''); }

    async function addRecord() {
        const amt = parseFloat(document.getElementById('amount').value);
        const date = document.getElementById('date').value;
        if(!date || isNaN(amt)) return;
        records.push({ id: Date.now(), type: currentType, date, desc: document.getElementById('desc').value, category: document.getElementById('cat-select').value, amount: amt });
        document.getElementById('amount').value=''; document.getElementById('desc').value='';
        render(); await saveToCloud();
    }

    async function delRecord(id) {
        if(confirm("Elimina?")){ records = records.filter(r=>r.id!==id); render(); await saveToCloud(); }
    }

    function render() {
        const selM = parseInt(document.getElementById('month-filter').value);
        const rendCatEdit = (list, type, divId) => {
            document.getElementById(divId).innerHTML = list.map((c, i) => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${c.n}</span><span>‚Ç¨${c.b}</span></div>`).join('');
        };
        rendCatEdit(catsInc, 'inc', 'edit-cats-inc'); rendCatEdit(catsExp, 'exp', 'edit-cats-exp');

        // Tabelle Annuali
        const head = '<th class="row-label">Cat</th>' + months.map(m => `<th>${m.substring(0,3)}</th>`).join('') + '<th>TOT</th>';
        ['h-sum', 'h-inc', 'h-exp'].forEach(id => document.getElementById(id).innerHTML = head);

        let mStats = months.map(() => ({ inc: 0, exp: 0 }));
        const fillAnnual = (list, type, bodyId) => {
            const body = document.getElementById(bodyId); body.innerHTML = '';
            list.forEach(c => {
                let row = `<td class="row-label">${c.n}</td>`; let tot = 0;
                months.forEach((_, i) => {
                    const val = records.filter(r => r.type === type && r.category === c.n && new Date(r.date).getMonth() === i).reduce((s,r)=>s+r.amount, 0);
                    row += `<td>${val > 0 ? val.toFixed(0) : '-'}</td>`; tot += val;
                    if(type === 'Entrata') mStats[i].inc += val; else mStats[i].exp += val;
                });
                body.innerHTML += `<tr>${row}<td>${tot.toFixed(0)}</td></tr>`;
            });
        };
        fillAnnual(catsInc, 'Entrata', 'b-inc'); fillAnnual(catsExp, 'Uscita', 'b-exp');

        // Riepilogo Annuale Saldo
        let sumBody = document.getElementById('b-sum'); sumBody.innerHTML = '';
        const createSumRow = (lbl, key) => {
            let r = `<td class="row-label">${lbl}</td>`; let t = 0;
            mStats.forEach(m => { let v = (key==='net'?m.inc-m.exp:m[key]); t+=v; r+=`<td>${v.toFixed(0)}</td>`; });
            return `<tr>${r}<td>${t.toFixed(0)}</td></tr>`;
        };
        sumBody.innerHTML = createSumRow('Entrate', 'inc') + createSumRow('Uscite', 'exp') + createSumRow('Saldo', 'net');

        // Vista Mensile
        const buildMTable = (list, type, bodyId) => {
            const body = document.getElementById(bodyId); body.innerHTML = '';
            list.forEach(c => {
                const real = records.filter(r => r.type === type && r.category === c.n && new Date(r.date).getMonth() === selM).reduce((s,r)=>s+r.amount, 0);
                body.innerHTML += `<tr><td>${c.n}</td><td>${c.b}</td><td>${real.toFixed(0)}</td><td>${(real-c.b).toFixed(0)}</td></tr>`;
            });
        };
        buildMTable(catsInc, 'Entrata', 'm-inc-body'); buildMTable(catsExp, 'Uscita', 'm-exp-body');
        
        // Storico
        document.getElementById('history-body').innerHTML = records.slice().reverse().map(r => `<tr><td>${r.date}</td><td>${r.desc}</td><td>${r.category}</td><td>${r.type}</td><td>‚Ç¨${r.amount}</td><td><button onclick="delRecord(${r.id})">üóëÔ∏è</button></td></tr>`).join('');

        updateCharts(mStats, selM);
    }

    function updateCharts(mStats, selM) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, { type: 'bar', data: { labels: months.map(m=>m.substring(0,3)), datasets: [{ label: 'Saldo', data: mStats.map(m=>m.inc-m.exp), backgroundColor: '#3498db' }] }, options: { responsive: true, maintainAspectRatio: false } });

        // Chart Mensili Semplificati
        const drawMChart = (id, type) => {
            const c = document.getElementById(id).getContext('2d');
            const real = records.filter(r => r.type === type && new Date(r.date).getMonth() === selM).reduce((s,r)=>s+r.amount, 0);
            const prev = (type === 'Entrata' ? catsInc : catsExp).reduce((s,c)=>s+c.b, 0);
            if(window[id+'_obj']) window[id+'_obj'].destroy();
            window[id+'_obj'] = new Chart(c, { type: 'bar', data: { labels: ['Previsto', 'Reale'], datasets: [{ data: [prev, real], backgroundColor: ['#3498db', '#27ae60'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        };
        drawMChart('mChartInc', 'Entrata'); drawMChart('mChartExp', 'Uscita');
    }

    function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) { google.accounts.oauth2.revoke(token.access_token); gapi.client.setToken(''); location.reload(); }
    }
</script>
</body>
</html>
