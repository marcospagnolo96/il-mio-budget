<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Cloud Multi-Year Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --info: #3498db; --bg: #f8f9fa; --card-bg: white; --text-main: #2c3e50; --border-color: #ddd; }
        body.dark-theme { --primary: #ecf0f1; --bg: #1a1a1a; --card-bg: #2d2d2d; --text-main: #e0e0e0; --border-color: #444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: white; padding: 10px 15px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; font-size: 0.85rem; }
        body.dark-theme .sidebar { background: #252525; }
        .nav-btn { padding: 8px 12px; margin-bottom: 3px; border: none; background: #eee; text-align: left; cursor: pointer; font-weight: bold; border-radius: 6px; font-size: 0.8rem; }
        body.dark-theme .nav-btn { background: #333; color: #eee; }
        .nav-btn.active { background: var(--primary); color: white; }
        
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        
        .form-box { background: #fdfdfd; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); margin-top: 8px; }
        body.dark-theme .form-box { background: var(--card-bg); }
        input, select, .btn-save { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; margin-bottom: 6px; font-size: 0.8rem; }
        .btn-save { background: var(--primary); color: white; font-weight: bold; cursor: pointer; border: none; }

        /* Layout Grafici Affiancati con Fix Padding */
        .charts-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .chart-box { flex: 1; min-height: 280px; background: white; border-radius: 10px; padding: 10px 10px 40px 10px; border: 1px solid var(--border-color); position: relative; box-sizing: border-box; }
        body.dark-theme .chart-box { background: var(--card-bg); }

        .table-container { background: white; padding: 10px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); overflow-x: auto; }
        body.dark-theme .table-container { background: var(--card-bg); }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        table th, table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }
        
        .type-selector { display: flex; gap: 5px; margin-bottom: 8px; }
        .type-btn { flex: 1; padding: 6px; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: bold; border-radius: 6px; font-size: 0.7rem; }
        .type-btn.inc-active { border-color: var(--success); color: var(--success); }
        .type-btn.exp-active { border-color: var(--danger); color: var(--danger); }
        .val-inc { color: var(--success); font-weight: bold; }
        .val-exp { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div id="auth-screen" style="position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;">
    <h1>ðŸ’° Wallet Cloud</h1>
    <button onclick="handleAuthClick()" style="padding: 15px 30px; cursor: pointer;">ACCEDI CON GOOGLE</button>
</div>

<aside class="sidebar">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2>ðŸ“Š Wallet</h2>
        <select id="year-selector" onchange="render()"></select>
    </div>
    
    <button class="nav-btn active" onclick="showPage('dashboard', this)">Riepilogo Annuale</button>
    <button class="nav-btn" onclick="showPage('history', this)">Lista & Categorie</button>
    
    <div id="sync-status" style="font-size: 0.7rem; margin: 5px 0;">Connessione...</div>

    <div class="form-box">
        <h4>Nuovo Movimento</h4>
        <div class="type-selector">
            <button id="btn-inc" class="type-btn inc-active" onclick="setType('Entrata')">Entrata</button>
            <button id="btn-exp" class="type-btn" onclick="setType('Uscita')">Uscita</button>
        </div>
        <input type="date" id="date">
        <input type="text" id="desc" placeholder="Descrizione">
        <select id="cat-select"></select>
        <input type="number" id="amount" step="0.01" placeholder="Importo â‚¬">
        <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 8px;">
            <input type="checkbox" id="is-recurring" style="width: auto; margin: 0;">
            <label for="is-recurring" style="font-size: 0.75rem;">Ricorrente ogni mese</label>
        </div>
        <button class="btn-save" onclick="addRecord()">SALVA</button>
    </div>
</aside>

<main class="main-content">
    <div id="dashboard" class="page active">
        <div class="charts-row">
            <div class="chart-box"><canvas id="mainChart"></canvas></div>
            <div class="chart-box"><canvas id="forecastChart"></canvas></div>
        </div>
        <div class="table-container">
            <table><thead><tr id="h-sum"></tr></thead><tbody id="b-sum"></tbody></table>
        </div>
    </div>

    <div id="history" class="page">
        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div class="table-container" style="flex:1">
                <h4>Categorie Entrate</h4>
                <div id="edit-cats-inc"></div>
            </div>
            <div class="table-container" style="flex:1">
                <h4>Categorie Uscite</h4>
                <div id="edit-cats-exp"></div>
            </div>
        </div>
        <h3>Storico Movimenti</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>Data</th><th>Descrizione</th><th>Categoria</th><th>Tipo</th><th>Importo</th><th>Azioni</th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    const CLIENT_ID = '748854814089-olhm7pebtjdn7beu9j5jt7n8hfj8pih2.apps.googleusercontent.com';
    const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";
    let tokenClient, gapiInited = false, gisInited = false, fileId = null;
    
    let records = [];
    let catsInc = [{n: "Stipendio", b: 2000}];
    let catsExp = [{n: "Cibo", b: 400}, {n: "Casa", b: 600}];
    let currentType = 'Entrata';
    const months = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];

    function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; }); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; }
    async function handleAuthClick() { tokenClient.callback = async (resp) => { document.getElementById('auth-screen').style.display = 'none'; await syncData(); }; tokenClient.requestAccessToken({prompt: 'consent'}); }

    async function syncData() {
        const response = await gapi.client.drive.files.list({ q: "name = 'wallet_data.json' and trashed = false" });
        if (response.result.files.length > 0) {
            fileId = response.result.files[0].id;
            const res = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            records = res.result.records || [];
            catsInc = res.result.catsInc || catsInc;
            catsExp = res.result.catsExp || catsExp;
        } else { await saveToCloud(true); }
        render();
    }

    async function saveToCloud(isNew = false) {
        const content = JSON.stringify({records, catsInc, catsExp});
        if (isNew) {
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=media', { method: 'POST', headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token, 'Content-Type': 'application/json' }, body: content });
            const json = await res.json(); fileId = json.id;
            await gapi.client.drive.files.update({ fileId: fileId, resource: { name: 'wallet_data.json' } });
        } else {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + gapi.client.getToken().access_token, 'Content-Type': 'application/json' }, body: content });
        }
    }

    function render() {
        updateCatDropdown();
        // Logica Rendering Tabella Riepilogo (Esempio semplificato per brevitÃ , ripristina la tua se necessario)
        const year = document.getElementById('year-selector').value;
        const filtered = records.filter(r => new Date(r.date).getFullYear().toString() === year);
        
        // Rendering Storico
        document.getElementById('history-body').innerHTML = filtered.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(r => `
            <tr>
                <td>${r.date}</td>
                <td>${r.desc} ${r.recurring ? 'ðŸ”„' : ''}</td>
                <td>${r.category}</td>
                <td class="${r.type==='Entrata'?'val-inc':'val-exp'}">${r.type}</td>
                <td>${r.amount} â‚¬</td>
                <td><button onclick="delRecord(${r.id})">âœ•</button></td>
            </tr>
        `).join('');

        updateCharts(filtered);
    }

    let c1, c2;
    function updateCharts(data) {
        if(c1) c1.destroy(); if(c2) c2.destroy();
        const ctxOpts = { 
            responsive: true, 
            maintainAspectRatio: false, 
            layout: { padding: { bottom: 20 } }, // FIX: Spazio per nomi mesi
            plugins: { legend: { display: false } } 
        };

        const mValues = months.map((_, i) => {
            const mData = data.filter(r => new Date(r.date).getMonth() === i);
            return mData.reduce((acc, r) => r.type === 'Entrata' ? acc + r.amount : acc - r.amount, 0);
        });

        c1 = new Chart(document.getElementById('mainChart'), {
            type: 'bar',
            data: { labels: months.map(m => m.substring(0,3)), datasets: [{ data: mValues, backgroundColor: '#3498db' }] },
            options: ctxOpts
        });

        c2 = new Chart(document.getElementById('forecastChart'), {
            type: 'line',
            data: { labels: months.map(m => m.substring(0,3)), datasets: [{ data: mValues, borderColor: '#27ae60' }] },
            options: ctxOpts
        });
    }

    function addRecord() {
        const amt = parseFloat(document.getElementById('amount').value);
        if(!amt) return;
        records.push({
            id: Date.now(),
            type: currentType,
            date: document.getElementById('date').value,
            desc: document.getElementById('desc').value,
            category: document.getElementById('cat-select').value,
            amount: amt,
            recurring: document.getElementById('is-recurring').checked
        });
        saveToCloud(); render();
    }

    function delRecord(id) { records = records.filter(r => r.id !== id); saveToCloud(); render(); }
    function setType(t) { currentType = t; render(); }
    function updateCatDropdown() {
        const cats = currentType === 'Entrata' ? catsInc : catsExp;
        document.getElementById('cat-select').innerHTML = cats.map(c => `<option value="${c.n}">${c.n}</option>`).join('');
    }
    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    window.onload = () => {
        const ys = document.getElementById('year-selector');
        [2024,2025,2026,2027].forEach(y => { const o=document.createElement('option'); o.value=y; o.text=y; if(y===2026) o.selected=true; ys.appendChild(o); });
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
    };
</script>
</body>
</html>
