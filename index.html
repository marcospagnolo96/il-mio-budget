<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Cloud Multi-Year</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --info: #3498db; --bg: #f8f9fa; --card-bg: white; --text-main: #2c3e50; --border-color: #ddd; }
        body.dark-theme { --primary: #ecf0f1; --bg: #1a1a1a; --card-bg: #2d2d2d; --text-main: #e0e0e0; --border-color: #444; }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: white; padding: 10px 15px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; }
        body.dark-theme .sidebar { background: #252525; }
        
        .nav-btn { padding: 10px; margin-bottom: 5px; border: none; background: #eee; text-align: left; cursor: pointer; font-weight: bold; border-radius: 6px; }
        .nav-btn.active { background: var(--primary); color: white; }
        
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        
        .form-box { background: #fdfdfd; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); margin-top: 10px; }
        input, select, .btn-save { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; margin-bottom: 8px; }
        .btn-save { background: var(--primary); color: white; font-weight: bold; cursor: pointer; border: none; }
        
        /* FIX GRAFICI AFFIANCATI E PADDING */
        .charts-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .chart-box { flex: 1; min-height: 300px; background: white; border-radius: 10px; padding: 15px 15px 40px 15px; border: 1px solid var(--border-color); position: relative; }
        body.dark-theme .chart-box { background: var(--card-bg); }

        .table-container { background: white; padding: 15px; border-radius: 10px; margin-bottom: 25px; border: 1px solid var(--border-color); overflow-x: auto; }
        body.dark-theme .table-container { background: var(--card-bg); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        table th, table td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
        
        .type-selector { display: flex; gap: 5px; margin-bottom: 10px; }
        .type-btn { flex: 1; padding: 8px; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: bold; border-radius: 6px; }
        .type-btn.inc-active { border-color: var(--success); color: var(--success); }
        .type-btn.exp-active { border-color: var(--danger); color: var(--danger); }
    </style>
</head>
<body>

<aside class="sidebar">
    <h2>ðŸ’° Wallet</h2>
    <button class="nav-btn active" onclick="showPage('dashboard', this)">Riepilogo Annuale</button>
    <button class="nav-btn" onclick="showPage('history', this)">Lista & Categorie</button>
    
    <div class="form-box">
        <h4>Nuovo Movimento</h4>
        <div class="type-selector">
            <button id="btn-inc" class="type-btn inc-active" onclick="setType('Entrata')">Entrata</button>
            <button id="btn-exp" class="type-btn" onclick="setType('Uscita')">Uscita</button>
        </div>
        <input type="date" id="date">
        <input type="text" id="desc" placeholder="Descrizione">
        <select id="cat-select"></select>
        <input type="number" id="amount" placeholder="Importo â‚¬">
        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="is-recurring" style="width: auto; margin: 0;">
            <label for="is-recurring" style="font-size: 0.8rem;">Movimento Ricorrente</label>
        </div>
        <button class="btn-save" onclick="addRecord()">SALVA</button>
    </div>
</aside>

<main class="main-content">
    <div id="dashboard" class="page active">
        <div class="charts-row">
            <div class="chart-box">
                <canvas id="mainChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="forecastChart"></canvas>
            </div>
        </div>
        <div class="table-container">
            <table id="summary-table">
                </table>
        </div>
    </div>

    <div id="history" class="page">
        <h3>Impostazioni Categorie</h3>
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div class="table-container" style="flex:1">
                <h4>Entrate</h4>
                <div id="cats-inc-list"></div>
            </div>
            <div class="table-container" style="flex:1">
                <h4>Uscite</h4>
                <div id="cats-exp-list"></div>
            </div>
        </div>
        <h3>Storico</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Data</th><th>Descrizione</th><th>Cat.</th><th>Tipo</th><th>Importo</th><th>Azioni</th></tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    let records = []; 
    let currentType = 'Entrata';
    const months = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];

    // Inizializzazione Grafici con FIX PADDING
    function initCharts() {
        const ctx1 = document.getElementById('mainChart').getContext('2d');
        const ctx2 = document.getElementById('forecastChart').getContext('2d');
        
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: { bottom: 20, left: 10, right: 10, top: 10 }
            },
            scales: {
                x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
            }
        };

        window.c1 = new Chart(ctx1, { type: 'bar', data: { labels: months, datasets: [] }, options: commonOptions });
        window.c2 = new Chart(ctx2, { type: 'line', data: { labels: months, datasets: [] }, options: commonOptions });
    }

    function addRecord() {
        const record = {
            id: Date.now(),
            date: document.getElementById('date').value,
            desc: document.getElementById('desc').value,
            category: document.getElementById('cat-select').value,
            amount: parseFloat(document.getElementById('amount').value),
            type: currentType,
            recurring: document.getElementById('is-recurring').checked
        };
        records.push(record);
        render();
    }

    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function setType(t) {
        currentType = t;
        document.getElementById('btn-inc').className = t === 'Entrata' ? 'type-btn inc-active' : 'type-btn';
        document.getElementById('btn-exp').className = t === 'Uscita' ? 'type-btn exp-active' : 'type-btn';
    }

    window.onload = () => {
        initCharts();
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
    };

    function render() {
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = records.map(r => `
            <tr>
                <td>${r.date}</td>
                <td>${r.desc} ${r.recurring ? 'ðŸ”„' : ''}</td>
                <td>${r.category}</td>
                <td>${r.type}</td>
                <td>${r.amount}â‚¬</td>
                <td><button onclick="records = records.filter(x=>x.id!==${r.id}); render();">Elimina</button></td>
            </tr>
        `).join('');
    }
</script>
</body>
</html>
